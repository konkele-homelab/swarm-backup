version: "3.9"

services:
  backup:
    image: your-registry/backup-container:latest

    volumes:
      - /data:/data:ro
      - /backup:/backup
      - /var/run/docker.sock:/var/run/docker.sock:ro

    environment:
      # Backup parameters
      BACKUP_SRC: /data
      BACKUP_DEST: /backup

      # Swarm scaling behavior
      SCALE_LABEL: "com.example.autobackup.enable"
      SCALE_VALUE: "true"

      # GFS retention rotation
      DAILY_COUNT: "7"
      WEEKLY_COUNT: "4"
      MONTHLY_COUNT: "6"

      # Email behavior
      EMAIL_ON_SUCCESS: "off"
      EMAIL_ON_FAILURE: "on"

      # SMTP baseline config (secrets override user/pass)
      SMTP_SERVER: "smtp.example.com"
      SMTP_PORT: "587"
      SMTP_TLS: "on"
      EMAIL_FROM: "backup@example.com"

      # Optional: container timezone
      TZ: "America/Chicago"

    secrets:
      - smtp_user
      - smtp_pass

    deploy:
      replicas: 0
      restart_policy:
        condition: none

      # Optional: run backup only on manager nodes
      placement:
        constraints:
          - node.role == manager

secrets:
  smtp_user:
    external: true

  smtp_pass:
    external: true
